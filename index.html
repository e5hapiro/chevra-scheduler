<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boulder Chevra Kadisha Volunteer Portal</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Google Fonts: Karla (Text) and Playfair Display (Headline Substitute for Adonis/Larkin) -->
    <link href="https://fonts.googleapis.com/css2?family=Karla:ital,wght@0,200..800;1,200..800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    
    <script>
        // Configure Tailwind to use the custom colors and fonts
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Backgrounds and Base Colors
                        'brand-background': '#F9F4ED', // Body BG / Lightest Color (Design #1)
                        'brand-text': '#3D4066',     // Dark Blue/Gray for Primary Text and Header BG (Design #2)
                        'brand-info-bg': '#EAE0D6', // Light Tan/Grey for Information Boxes
                        'brand-shift-border': '#C8CCCE', // Light border for shifts

                        // Action Colors
                        'brand-accent': '#0072BC',    // Blue: Active State / Borders / Secondary Action
                        'brand-signup': '#E0A960',    // Gold: Primary Action Button BG
                        'brand-full': '#F05252',      // Red for full/cancel/warning
                        'brand-cancel': '#A63A3A',    // Darker Red for cancel
                    },
                    fontFamily: {
                        headline: ['"Playfair Display"', 'serif'], // Used for titles and key text
                        text: ['Karla', 'sans-serif'],          // Used for body text
                    },
                },
            }
        }
    </script>
    <style>
        /* Apply brand background and base font globally */
        body {
            background-color: #F9F4ED; /* Background of #1 */
            color: #3D4066;
            font-family: 'Karla', sans-serif;
        }
        html, body {
            height: 100%;
            margin: 0;
            box-sizing: border-box;
        }
        /* Explicitly apply headline font for headings/titles */
        .font-headline {
            font-family: 'Playfair Display', serif;
        }
        /* Tab Content Control */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Custom Tab Button Transition */
        .tab-button {
            border-bottom: 3px solid transparent;
            margin-bottom: -1px; /* To prevent double border with parent */
        }
        .tab-button.active {
            border-bottom: 3px solid #0072BC; /* brand-accent */
            color: #0072BC !important; /* brand-accent */
        }
    </style>
</head>
<body class="font-text antialiased">
    <div class="h-full flex flex-col">
        
        <!-- Header (Design #2 Structure & Style) -->
        <header class="shadow-lg bg-brand-text">
            <div class="max-w-7xl mx-auto px-6 py-8">
                <div class="flex items-center justify-between">
                    <h1 class="text-3xl font-bold leading-tight text-brand-background">
                        <span class="font-headline">BOULDER CHEVRA KADISHA</span><br>
                        <span class="font-headline">Shmira Schedule</span>
                    </h1>
                    <div class="flex items-center gap-4">
                        <!-- Bulk Signup Button -->
                        <button id="bulk-signup-btn"
                            class="bg-brand-signup text-white py-2 px-6 rounded-lg font-bold transition-colors duration-150 hover:bg-brand-signup/90 disabled:opacity-50"
                            onclick="performBulkSignup()" disabled>
                            Sign Up for Selected Shifts
                        </button>
                        <span id="welcome-message" class="font-headline text-brand-background"></span>
                        <div class="w-12 h-12 rounded-full flex items-center justify-center font-semibold text-brand-text" style="background-color: #E0A960;">
                            SM
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto">
            <div class="max-w-7xl mx-auto px-6 py-8">
                
                <!-- Tab Navigation (Design #2 Structure) -->
                <div class="mb-6">
                    <div class="flex gap-2 mb-0 border-b border-brand-shift-border">
                        <button onclick="switchTab('schedule')" id="tab-schedule" class="tab-button active px-6 py-3 font-semibold rounded-t-lg transition-all bg-brand-background text-brand-accent shadow-md">
                            Schedule Shifts
                        </button>
                        <button onclick="switchTab('myshifts')" id="tab-myshifts" class="tab-button px-6 py-3 font-semibold rounded-t-lg transition-all bg-brand-info-bg text-brand-text/80 hover:bg-brand-background hover:text-brand-accent shadow-sm">
                            My Shifts
                        </button>
                        <button onclick="switchTab('events')" id="tab-events" class="tab-button px-6 py-3 font-semibold rounded-t-lg transition-all bg-brand-info-bg text-brand-text/80 hover:bg-brand-background hover:text-brand-accent shadow-sm">
                            Mortuary Information
                        </button>
                        <button onclick="switchTab('signups')" id="tab-signups" class="tab-button px-6 py-3 font-semibold rounded-t-lg transition-all bg-brand-info-bg text-brand-text/80 hover:bg-brand-background hover:text-brand-accent shadow-sm">
                            Volunteer History
                        </button>
                    </div>
                    
                    <!-- Tab Content Container -->
                    <div class="bg-brand-background rounded-lg shadow-md border border-t-0 border-brand-shift-border">

                        <!-- Tab Content -->
                        <div class="p-6">
                            
                            <!-- Schedule Shifts Tab -->
                            <div id="content-schedule" class="tab-content active">
                                <h2 class="text-2xl font-bold mb-6 font-headline text-brand-text">Available Shifts</h2>
                                
                                <!-- Available Shifts -->
                                <div class="grid gap-6" id="available-shifts-grid"></div>

                            </div>

                            <!-- My Shifts Tab -->
                            <div id="content-myshifts" class="tab-content">
                                <h2 class="text-2xl font-bold mb-6 font-headline text-brand-text">My Scheduled Shifts</h2>
                                
                                <div class="grid gap-4">
                                    <div class="bg-brand-background border-l-4 rounded-xl p-6 shadow-sm border-brand-accent border-2 hover:shadow-lg transition-shadow">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <h3 class="text-lg font-semibold font-headline text-brand-text">Full Name Shmira</h3>
                                                <p class="text-brand-text">Location: Location</p>
                                                <p class="text-brand-text">Shift Date and Time</p>
                                            </div>
                                            <button onclick="cancelShift('shift-x')" class="text-white px-3 py-1 rounded-full text-sm font-medium bg-brand-full hover:bg-brand-cancel transition-colors shadow-md">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>

                                    <div class="bg-brand-background border-l-4 rounded-xl p-6 shadow-sm border-brand-accent border-2 hover:shadow-lg transition-shadow">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <h3 class="text-lg font-semibold font-headline text-brand-text">Full Name Shmira</h3>
                                                <p class="text-brand-text">Location: Location</p>
                                                <p class="text-brand-text">Shift Date and Time</p>
                                            </div>
                                            <button onclick="cancelShift('shift-y')" class="text-white px-3 py-1 rounded-full text-sm font-medium bg-brand-full hover:bg-brand-cancel transition-colors shadow-md">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Mortuary Information Tab (UPDATED) -->
                            <div id="content-events" class="tab-content">
                                <h2 class="text-2xl font-bold mb-6 font-headline text-brand-text">Mortuary Information</h2>
                                
                                <div class="grid gap-6">
                                    
                                    <!-- Crist Mortuary Block - UPDATED STRUCTURE -->
                                    <div class="bg-brand-background rounded-xl shadow-lg overflow-hidden border border-brand-shift-border">
                                        <!-- Header Section -->
                                        <div class="px-6 py-4 bg-brand-info-bg border-b border-brand-shift-border">
                                            <h3 class="text-lg font-semibold text-brand-text">Crist Mortuary</h3>
                                        </div>
                                        <!-- Body Section -->
                                        <div class="p-6 text-brand-text"> 
                                            <div class="mb-4 opacity-90">
                                                <p>3395 Penrose Place</p>
                                                <p>Boulder, CO 80301</p>
                                                <p class="mb-2">303-442-4411</p>
                                                <a href="https://maps.google.com/?q=3395+Penrose+Place,+Boulder,+CO+80301" target="_blank" rel="noopener noreferrer" class="inline-flex items-center underline hover:no-underline text-brand-accent">
                                                    üìç Get Directions
                                                </a>
                                            </div>
                                            <!-- General Info -->
                                            <p class="leading-relaxed">
                                               ADD GEN‚Äô MORTUARY INFO - LOCATION OF SHMIRA ROOM / BATHROOMS
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Greenwood & Myers Mortuary Block - UPDATED STRUCTURE -->
                                    <div class="bg-brand-background rounded-xl shadow-lg overflow-hidden border border-brand-shift-border">
                                        <!-- Header Section -->
                                        <div class="px-6 py-4 bg-brand-info-bg border-b border-brand-shift-border">
                                            <h3 class="text-lg font-semibold text-brand-text">Greenwood & Myers Mortuary</h3>
                                        </div>
                                        <!-- Body Section -->
                                        <div class="p-6 text-brand-text">
                                            <div class="mb-4 opacity-90">
                                                <p>2969 Baseline Road</p>
                                                <p>Boulder, CO 80303</p>
                                                <p class="mb-2">(303) 440-3960</p>
                                                <a href="https://maps.google.com/?q=2969+Baseline+Road,+Boulder,+CO+80303" target="_blank" rel="noopener noreferrer" class="inline-flex items-center underline hover:no-underline text-brand-accent">
                                                    üìç Get Directions
                                                </a>
                                            </div>
                                            <!-- General Info -->
                                            <p class="leading-relaxed">
                                                ADD GEN‚Äô MORTUARY INFO - LOCATION OF SHMIRA ROOM / BATHROOMS
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Volunteer History Tab - UPDATED CONTENT AND STRUCTURE -->
                            <div id="content-signups" class="tab-content">
                                <h2 class="text-2xl font-bold mb-6 font-headline text-brand-text">Your Volunteer History</h2>
                                
                                <!-- Explanatory Note for YTD Focus -->
                                <p class="text-sm text-brand-text/80 mb-6 p-4 rounded-lg bg-brand-info-bg border border-brand-shift-border">
                                    Since a full historical year of data is not yet available, the statistics below focus on **Year-To-Date (YTD) 2025** figures. Once data for previous years is logged, this section will include a selector to view past historical trends.
                                </p>
                                
                                <!-- Section 1: Your YTD Stats - Grid of 3 -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                    <div class="rounded-xl p-6 text-white shadow-lg" style="background: #3D4066;">
                                        <div class="text-3xl font-bold mb-1">47</div>
                                        <div class="text-white opacity-90">2025 YTD Hours</div>
                                    </div>
                                    <div class="rounded-xl p-6 text-white shadow-lg" style="background: #3D4066;">
                                        <div class="text-3xl font-bold mb-1">156</div>
                                        <div class="text-white opacity-90">2025 YTD Number of Different Shmira</div>
                                    </div>
                                    <div class="rounded-xl p-6 text-white shadow-lg" style="background: #3D4066;">
                                        <div class="text-3xl font-bold mb-1">85%</div>
                                        <div class="text-white opacity-90">2025 Anything else</div>
                                    </div>
                                </div> 

                                <!-- Section 2: Your Volunteer Stats by Year (Updated Header) -->
                                <div class="mb-8 bg-brand-background rounded-xl shadow-lg overflow-hidden border border-brand-shift-border">
                                    <div class="px-6 py-4 bg-brand-info-bg border-b border-brand-shift-border">
                                        <h3 class="text-lg font-semibold text-brand-text">Your Volunteer Stats (2025 YTD)</h3>
                                    </div>
                                    <div class="p-6">
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div class="text-center">
                                                <div class="text-2xl font-bold text-brand-accent">12</div>
                                                <div class="text-brand-text">2025 Hours</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="text-2xl font-bold text-brand-accent">5</div>
                                                <div class="text-brand-text">2025 Number of Different Shmira</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="text-2xl font-bold text-brand-accent">tbd</div>
                                                <div class="text-brand-text">2025 Anything else</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Section 3: Boulder Chevra Kadisha Shmira Stats by Year (Updated Header) -->
                                <div class="bg-brand-background rounded-xl shadow-lg overflow-hidden border border-brand-shift-border">
                                    <div class="px-6 py-4 bg-brand-info-bg border-b border-brand-shift-border">
                                        <h3 class="text-lg font-semibold text-brand-text">BCK Shmira Stats (2025 YTD)</h3>
                                    </div>
                                    <div class="p-6">
                                        <div class="space-y-6">
                                            <div>
                                                <div class="flex justify-between items-center mb-2">
                                                    <span class="font-medium text-brand-text">2025 YTD Total BCK Requested Shifts</span>
                                                    <span class="text-sm text-brand-text/70">2025 YTD Total BCK Filled Shifts</span>
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-3">
                                                    <div class="bg-brand-signup h-3 rounded-full" style="width: 80%"></div>
                                                </div>
                                                <div class="text-sm text-brand-text/70 mt-1">2025 YTD % Shifts Filled</div>
                                            </div>
                                            
                                            <div>
                                                <div class="flex justify-between items-center mb-2">
                                                    <span class="font-medium text-brand-text">Community Fair</span>
                                                    <span class="text-sm text-brand-text/70">18/25 shifts filled</span>
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-3">
                                                    <div class="bg-brand-signup h-3 rounded-full" style="width: 72%"></div>
                                                </div>
                                                <div class="text-sm text-brand-text/70 mt-1">72% complete</div>
                                            </div>
                                            
                                            <div>
                                                <div class="flex justify-between items-center mb-2">
                                                    <span class="font-medium text-brand-text">Beach Cleanup</span>
                                                    <span class="text-sm text-brand-text/70">8/10 shifts filled</span>
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-3">
                                                    <div class="bg-brand-signup h-3 rounded-full" style="width: 80%"></div>
                                                </div>
                                                <div class="text-sm text-brand-text/70 mt-1">80% complete</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>

        // Global set to track selected shifts
        var selectedShiftIds = new Set();
        var events = null;

        function init() {


            // Parse JSON string injected by server-side templating
            const data = JSON.parse(<?= data ?>);

            // Debug: log the entire events array first
            console.log('Data object:', data);

            events = data.events;

            const volunteerName = data.name;
            const volunteerToken = data.token;
            const isMember = data.isMember;

            // Debug: log the entire events array first
            console.log('Events object:', events);

            /*
            console.log("starting script init function");
            console.log("script volunteerName:", volunteerName);
            console.log("script volunteerToken:", volunteerToken);
            */

            // Display the welcome message and displaying the volunteer name
            const welcomeMessage = document.getElementById('welcome-message');
            if (welcomeMessage && volunteerName) {
                welcomeMessage.textContent = "Welcome, " + volunteerName;
            }

            // Generate the Shifts Table
            renderAvailableShifts(events);

            switchTab('schedule');
        }

        function renderAvailableShifts(events) {
            const shiftsContainer = document.getElementById('available-shifts-grid');
            shiftsContainer.innerHTML = '';

            events.forEach((event, idx) => {
                let eventHTML = `
                    <div class="border rounded-xl p-6 mb-6" style="background-color: #f9f4ed;">
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold text-brand-text">${event["Deceased Name"]} Shmira</h3>
                            <p class="text-brand-text">Location: ${event["Location"]}</p>
                            <p class="text-brand-text">Start: ${new Date(event["Start Date"]).toLocaleString()} to End: ${new Date(event["End Date"]).toLocaleString()}</p>
                        </div>
                        <div class="p-4 rounded-lg bg-brand-info-bg">
                            <h4 class="font-semibold mb-2 text-brand-text">About ${event["Deceased Name"]}</h4>
                            <p class="text-brand-text text-sm leading-relaxed">${event["Personal Information"] || ""}</p>
                        </div>
                        <div class="mt-6">
                            <h4 class="font-bold mb-2 text-brand-text">Available Shifts</h4>
                            <div class="space-y-2">
                                ${event.availableShifts.length === 0 ?
                                    '<p class="text-gray-500">No available shifts.</p>'
                                    :
                                    event.availableShifts.map(shift =>
                                        `<button
                                            class="shift-select-btn ${selectedShiftIds.has(shift["Shift ID"]) ? "bg-brand-signup text-white" : "bg-white text-brand-signup"}"
                                            style="width:100%; padding:1em; margin-bottom:0.5em; border:1px solid #EEE; border-radius:8px; transition:background 0.2s;"
                                            data-shift-id="${shift["Shift ID"]}"
                                            onclick="toggleShiftSelection('${shift["Shift ID"]}')"
                                        >
                                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                                <div>
                                                    <p class="font-semibold">${shift["Shift Time"]}</p>
                                                    <p class="text-sm">${shift["Location"] || "Location unknown"}</p>
                                                </div>
                                                <span>${selectedShiftIds.has(shift["Shift ID"]) ? "‚úì Selected" : "Select"}</span>
                                            </div>
                                        </button>`
                                    ).join('')
                                }
                            </div>
                        </div>
                    </div>
                `;
                shiftsContainer.innerHTML += eventHTML;
            });
            updateBulkSignupButtonState();
        }

        function toggleShiftSelection(shiftId) {
            if (selectedShiftIds.has(shiftId)) {
                selectedShiftIds.delete(shiftId);
            } else {
                selectedShiftIds.add(shiftId);
            }
            renderAvailableShifts(events); // 'events' should be your current displayed events array
            updateBulkSignupButtonState();
        }

        function updateBulkSignupButtonState() {
            const btn = document.getElementById('bulk-signup-btn');
            btn.disabled = selectedShiftIds.size === 0;
        }

        function performBulkSignup() {
            closeBulkModal && closeBulkModal(); // If modal present
            dom.loading.classList.remove("hidden");
            const ids = Array.from(selectedShiftIds);
            if (ids.length === 0) {
                showMessage("No shifts were selected for bulk signup.", "warning");
                dom.loading.classList.add("hidden");
                return;
            }
            google.script.run
                .withSuccessHandler(handleBulkSignupResponse)
                .withFailureHandler(handleServerError)
                .handleBulkShiftSignup(ids, volunteerToken);
        }

        function switchTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => {
                content.classList.remove('active');
            });

            // Deactivate all tab buttons
            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => {
                tab.classList.remove('active', 'bg-brand-background', 'text-brand-accent', 'shadow-md');
                tab.classList.add('bg-brand-info-bg', 'text-brand-text/80', 'shadow-sm');
            });

            // Show selected tab content
            document.getElementById('content-' + tabName).classList.add('active');

            // Activate selected tab button
            const activeTab = document.getElementById('tab-' + tabName);
            activeTab.classList.remove('bg-brand-info-bg', 'text-brand-text/80', 'shadow-sm');
            activeTab.classList.add('active', 'bg-brand-background', 'text-brand-accent', 'shadow-md');
        }

        function signUpForShift(shiftId) {
            // Replaces alert() with a temporary message box
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-4 right-4 bg-brand-signup text-white px-6 py-3 rounded-lg shadow-lg z-50';
            messageDiv.textContent = '‚úÖ Successfully signed up for shift!';
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Note: The cancelShift and confirmCancel functions use the forbidden window.confirm()/alert() replacement
        // pattern from the original Design #2. I have kept the visual implementation to preserve the design logic.

        function cancelShift(shiftId) {
            // Create inline confirmation
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDiv.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl">
                    <h3 class="text-lg font-semibold text-brand-text mb-4 font-headline">Cancel Shift?</h3>
                    <p class="text-brand-text/80 mb-6">Are you sure you want to cancel this shift? This action cannot be undone.</p>
                    <div class="flex gap-3 justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-brand-text/70 hover:bg-gray-100 rounded-lg font-medium transition-colors">
                            Keep Shift
                        </button>
                        <button onclick="confirmCancel('${shiftId}')" class="px-4 py-2 bg-brand-full hover:bg-brand-cancel text-white rounded-lg font-medium shadow-md transition-colors">
                            Cancel Shift
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDiv);
        }

        function confirmCancel(shiftId) {
            // Remove confirmation dialog
            const confirmDialog = document.querySelector('.fixed.inset-0.bg-black');
            if(confirmDialog) confirmDialog.remove();
            
            // Show success message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-4 right-4 bg-brand-full text-white px-6 py-3 rounded-lg shadow-lg z-50';
            messageDiv.textContent = '‚ùå Shift cancelled successfully';
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Initialize to the Schedule Shifts tab on load
        window.onload = init;
    </script>
</body>
</html>
